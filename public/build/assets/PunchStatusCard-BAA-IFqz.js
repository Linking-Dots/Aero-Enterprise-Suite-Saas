import{V as J,a as e,j as u,F as f}from"./app-B-96MSI7.js";import{x as Q,s as W,r as l,u as X,e as D,g as Z,T as p,a as ee,B as h,w as j,G as m,R as A,p as te}from"./vendor-CHZiis0L.js";import{r as re,G as ne,B as y}from"./App-BawXaExW.js";import{L as g}from"./leaflet-src-DrB2RPaU.js";var S={},oe=Q;Object.defineProperty(S,"__esModule",{value:!0});var P=S.default=void 0,ae=oe(re()),ie=W;P=S.default=(0,ae.default)((0,ie.jsx)("path",{d:"M8.59 16.59 13.17 12 8.59 7.41 10 6l6 6-6 6z"}),"KeyboardArrowRight");const he=({handlePunchSuccess:M})=>{l.useState(null);const[v,k]=l.useState(null),o=X(),{auth:G}=J().props,[i,U]=l.useState(""),[s,w]=l.useState(""),[d,_]=l.useState(""),[b,I]=l.useState(null),[L,F]=l.useState(null),R=async()=>{w(null),_(null);const t=route("getCurrentUserPunch");try{let n=await fetch(t);n=await n.json();const r=n.punches;U(n.punches),I(n.total_production_time),F(n.isUserOnLeave),r&&r.length>0&&(r[r.length-1].punchin_time&&w(r[r.length-1].punchin_time),r[r.length-1].punchout_time&&_(r[r.length-1].punchout_time))}catch(n){console.error("Error fetching user attendance:",n),F(null)}},N=()=>{let[t,n,r]=b.split(":").map(Number);const a=(t*3600+n*60+r)*1e3+1e3;return t=Math.floor(a/(1e3*60*60)),n=Math.floor(a%(1e3*60*60)/(1e3*60)),r=Math.floor(a%(1e3*60)/1e3),`${String(t).padStart(2,"0")}:${String(n).padStart(2,"0")}:${String(r).padStart(2,"0")}`},Y=(t,n)=>{console.error("Location error:",t),t.code===t.PERMISSION_DENIED?y.error("Location permission denied. Please enable location services in your browser settings and try again.",{icon:"ðŸ”´",style:{backdropFilter:"blur(16px) saturate(200%)",background:o.glassCard.background,border:o.glassCard.border,color:o.palette.text.primary}}):y.error("Unable to retrieve location. Please try again.",{icon:"ðŸ”´",style:{backdropFilter:"blur(16px) saturate(200%)",background:o.glassCard.background,border:o.glassCard.border,color:o.palette.text.primary}})},q=async t=>{const n=new Promise(async(r,a)=>{navigator.geolocation?navigator.geolocation.getCurrentPosition(async c=>{const C=g.latLng(c.coords.latitude,c.coords.longitude),B=t==="punchin"?"/punchIn":"/punchOut",H={lat:23.987057,lng:90.361908},K={lat:23.690618,lng:90.546729};new g.Routing.OSRMv1().route([g.Routing.waypoint(g.latLng(H)),g.Routing.waypoint(g.latLng(K))],async(T,E)=>{var O,$;if(T||E.length===0){console.error("Routing error:",T),a(["Failed to calculate route."]);return}const V=E[0].coordinates;if(!z(V,C,200)){a(["You are out of the project area."]);return}try{const x=await axios.post(B,{user_id:G.user.id,location:`${C.lat.toFixed(4)}, ${C.lng.toFixed(4)}`});x.status===200?(await R(),M(),r([x.data.success?x.data.message:"Punch completed successfully"])):a(["Failed to set attendance. Please try again."])}catch(x){console.error(x),a([(($=(O=x.response)==null?void 0:O.data)==null?void 0:$.message)||"Failed to set attendance. Please try again."])}})},c=>{Y(c),a([`Error retrieving location: ${c.message}`])},{enableHighAccuracy:!0,timeout:1e4,maximumAge:0}):(y.error("Geolocation is not supported by this browser.",{icon:"ðŸ”´",style:{backdropFilter:"blur(16px) saturate(200%)",background:o.glassCard.background,border:o.glassCard.border,color:o.palette.text.primary}}),a(["Geolocation is not supported by this browser."]))});y.promise(n,{pending:{render(){return u("div",{style:{display:"flex",alignItems:"center"},children:[e(te,{}),e("span",{style:{marginLeft:"8px"},children:t==="punchin"?"Punching in...":"Punching out..."})]})},icon:!1,style:{backdropFilter:"blur(16px) saturate(200%)",background:o.glassCard.background,border:o.glassCard.border,color:o.palette.text.primary}},success:{render({data:r}){return e(f,{children:r.map((a,c)=>e("div",{children:a},c))})},icon:"ðŸŸ¢",style:{backdropFilter:"blur(16px) saturate(200%)",background:o.glassCard.background,border:o.glassCard.border,color:o.palette.text.primary}},error:{render({data:r}){return e(f,{children:r})},icon:"ðŸ”´",style:{backdropFilter:"blur(16px) saturate(200%)",background:o.glassCard.background,border:o.glassCard.border,color:o.palette.text.primary}}})};function z(t,n,r){for(let a of t){let c=g.latLng(a.lat,a.lng);if(n.distanceTo(c)<r)return!0}return!1}return l.useEffect(()=>{R()},[]),l.useEffect(()=>{if(!d){const t=setInterval(()=>{I(N())},1e3);return()=>clearInterval(t)}},[b,i,s,d]),l.useEffect(()=>{v&&q(v)},[v]),e(h,{sx:{display:"flex",height:"100%",justifyContent:"center",p:2},children:e(D,{in:!0,children:u(ne,{children:[e(Z,{title:e(p,{sx:{fontSize:{xs:"1.0rem",sm:"1.4rem",md:"1.8rem"}},children:"Today's Punch Status"})}),e(ee,{children:L?e(h,{sx:{display:"flex",flexDirection:"column"},children:e(p,{color:"error",sx:{fontSize:{xs:"1.0rem",sm:"1.2rem",md:"1.4rem"}},children:"You are on "+L.leave_type+" leave today."})}):u(f,{children:[u(h,{sx:{p:2,backdropFilter:"blur(16px) saturate(200%)",borderRadius:"25px",boxShadow:"0px 2px 4px -1px rgba(0,0,0,0.2),0px 4px 5px 0px rgba(0,0,0,0.14),0px 1px 10px 0px rgba(0,0,0,0.12)"},children:[e(p,{variant:"body2",id:"punch-in",children:i.length>0?"Punched In At":"Not Yet Punched In"}),e(j,{in:i.length>0,timeout:1e3,children:e(m,{container:!0,spacing:2,alignItems:"center",children:i.length>0&&i.map((t,n)=>u(A.Fragment,{children:[e(m,{item:!0,children:e(p,{variant:"h6",children:new Date(`${t==null?void 0:t.date}T${t==null?void 0:t.punchin_time}`).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0})})}),n<i.length-1&&e(m,{item:!0,children:e(P,{})})]},n))})})]}),e(h,{sx:{display:"flex",justifyContent:"center",alignItems:"center"},children:e(D,{in:!0,timeout:1e3,children:e(h,{onClick:()=>{!s||s&&d?k("punchin"):s&&!d&&k("punchout")},sx:{m:4,backdropFilter:"blur(16px) saturate(200%)",backgroundColor:s?s&&!d?"rgba(255, 0, 0, 0.3)":s&&d?"rgba(0, 128, 0, 0.3)":"":"rgba(0, 128, 0, 0.3)",border:"5px solid rgba(255, 255, 255, 0.125)",width:120,height:120,display:"flex",justifyContent:"center",alignItems:"center",borderColor:"inherit",cursor:"pointer",borderRadius:"50%",pointerEvents:"auto",boxShadow:"0px 2px 4px -1px rgba(0,0,0,0.2),0px 4px 5px 0px rgba(0,0,0,0.14),0px 1px 10px 0px rgba(0,0,0,0.12)"},children:e(h,{sx:{textAlign:"center"},children:e(p,{variant:"body1",children:u("span",{children:[s?s&&!d?`Punch Out ${b}`:s&&d?`Punch In ${b}`:"":"Punch In"," ",s&&u(f,{children:[e("br",{}),"hrs"]})]})})})})})}),u(h,{sx:{p:2,backdropFilter:"blur(16px) saturate(200%)",borderRadius:"25px",boxShadow:"0px 2px 4px -1px rgba(0,0,0,0.2),0px 4px 5px 0px rgba(0,0,0,0.14),0px 1px 10px 0px rgba(0,0,0,0.12)"},children:[e(p,{variant:"body2",id:"punch-out",children:i.length>0&&i[0].punchout_time?"Punched Out At":"Not Yet Punched Out"}),e(j,{in:i.length>0,timeout:1e3,children:e(m,{container:!0,spacing:2,alignItems:"center",children:i.length>0&&i[0].punchout_time&&i.map((t,n)=>{var r;return t.punchout_time?u(A.Fragment,{children:[e(m,{item:!0,children:e(p,{variant:"h6",children:new Date(`${t==null?void 0:t.date}T${t==null?void 0:t.punchout_time}`).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0})})}),i.length>0&&((r=i[n+1])==null?void 0:r.punchout_time)&&e(m,{item:!0,children:e(P,{})})]},n):""})})})]})]})})]})})})};export{he as default};
